<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="stylesheet" href="stylesProfessor.css" />
   <title>Boletim - Professor</title>
</head>
<body>
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="../imgs/menu.png" alt="Menu">
        <h2>Professor</h2>
      </div>
      <div class="nav-links">
        <a href="indexProfessor.html"><img src="../imgs/home.png" alt="Home">Início</a>
        <a href="desempenho.html"><img src="../imgs/turma.png" alt="Class">Desempenho da Turma</a>
        <a href="#"><img src="../imgs/faltas.png" alt="Faltas">Faltas</a>
        <a href="boletimProfessor.html"><img src="../imgs/grades.png" alt="Grades">Notas</a>
      </div>
    </nav>

   <div class="main-content" style="max-width: 100%;">
     <div class="login-container">
         <h2>Lançamento de Notas</h2>
         
         <div class="filtros-boletim">
           <div>
             <label for="turmaSelect">Turma:</label>
             <select id="turmaSelect" class="inputtabela"></select>
           </div>
           
           <div>
             <label for="trimestre-select">Trimestre:</label>
             <select id="trimestre-select" class="inputtabela">
                 <option value="1" selected>1º Trimestre</option>
                 <option value="2">2º Trimestre</option>
                 <option value="3">3º Trimestre</option>
             </select>
           </div>
         </div>
         
         <button id="carregarBtn" class="login-button">Carregar Alunos</button>
     </div>

     <div id="boletim-container" style="display: none;"></div>
     
     <button id="salvarTodosBtn" class="login-button" style="display: none;">
       Salvar Notas de Todos os Alunos
     </button>
   </div>

    <script>
      const boletim = document.getElementById('boletim-container')
      const turmaSelect = document.getElementById('turmaSelect');
      const boletimContainer = document.getElementById('boletim-container');
      const salvarTodosBtn = document.getElementById('salvarTodosBtn');
      
      let alunosCarregados = [];
      let disciplinaAtual = null;

      async function carregarTurmas() {
         const res = await fetch('/api/professor/turmas');
         const turmas = await res.json();
         turmaSelect.innerHTML = '<option value="">Selecione a Turma</option>';
         turmas.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id_turma;
            opt.textContent = `${t.ano}º ${t.serie}`;
            turmaSelect.appendChild(opt);
         });
      }

      function calcularN1(i1, i2, epa) {
         const ins1 = Number(i1) || 0;
         const ins2 = Number(i2) || 0;
         const epa_ = Number(epa) || 0;
         
         if (ins1 === 0 && ins2 === 0 && epa_ === 0) return '-';
         
         return ((ins1 + ins2 + epa_) / 3).toFixed(2);
      }

      function calcularMP(n1, n2, n3) {
         const nota1 = Number(n1) || 0;
         const nota2 = Number(n2) || 0;
         const nota3 = Number(n3) || 0;
         
         if (nota1 === 0 && nota2 === 0 && nota3 === 0) return '-';
         
         return ((nota1 + nota2 + (nota3 * 2)) / 4).toFixed(2);
      }

      function calcularMT(mp, rec) {
         const mpNum = Number(mp);
         const recNum = Number(rec);
         
         if (mp === '-' || isNaN(mpNum)) return '-';
         if (mpNum >= 6) return mpNum.toFixed(2);
         if (isNaN(recNum) || recNum === 0) return mpNum.toFixed(2);
         
         if (recNum > mpNum) {
            if (recNum > 6) return '6.00';
            return recNum.toFixed(2);
         }
         
         return mpNum.toFixed(2);
      }

      async function carregarAlunos() {
         const id_turma = turmaSelect.value;
         const id_trimestre = document.getElementById('trimestre-select').value; 

         if (!id_turma) {
            alert('Selecione a turma!');
            return;
         }

         const res = await fetch(`/api/professor/alunos?id_turma=${id_turma}&trimestre=${id_trimestre}`);
         const data = await res.json();

         if (!data.alunos || data.alunos.length === 0) {
            boletimContainer.innerHTML = '<p>Nenhum aluno encontrado.</p>';
            boletimContainer.style.display = 'block'; 
            salvarTodosBtn.style.display = 'none';
            return;
         }

         disciplinaAtual = data.id_disciplina;
         alunosCarregados = data.alunos;

         let tabela = `
         <table>
            <thead>
               <tr>
                  <th>Aluno</th>
                  <th>I1</th>
                  <th>I2</th>
                  <th>EPA</th>
                  <th>N1</th>
                  <th>N2</th>
                  <th>N3</th>
                  <th>MP</th>
                  <th>Rec</th>
                  <th>Faltas</th>
                  <th>MT</th>
               </tr>
            </thead>
            <tbody>
      `;

      alunosCarregados.forEach(a => {
         const n1 = calcularN1(a.i1, a.i2, a.epa);
         const mp = calcularMP(n1, a.n2, a.n3);
         const mt = calcularMT(mp, a.rec);
         
         tabela += `
            <tr>
               <td data-label="Aluno">${a.nome}</td>
               <td data-label="I1"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="i1-${a.id_aluno}" value="${a.i1 ?? ''}"></td>
               <td data-label="I2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="i2-${a.id_aluno}" value="${a.i2 ?? ''}"></td>
               <td data-label="EPA"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="epa-${a.id_aluno}" value="${a.epa ?? ''}"></td>
               <td data-label="N1" id="n1-display-${a.id_aluno}">${n1}</td>
               <td data-label="N2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="n2-${a.id_aluno}" value="${a.n2 ?? ''}"></td>
               <td data-label="N3"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="n3-${a.id_aluno}" value="${a.n3 ?? ''}"></td>
               <td data-label="MP" id="mp-display-${a.id_aluno}">${mp}</td>
               <td data-label="Rec"><input class="inputtabela" type="number" step="0.1" oninput="atualizarCalculos(${a.id_aluno})" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="rec-${a.id_aluno}" value="${a.rec ?? ''}" disabled></td>
               <td data-label="Faltas"><input class="inputtabela" type="number" step="1" min="0" id="faltas-${a.id_aluno}" value="${a.faltas ?? ''}"></td>
               <td data-label="MT" id="mt-display-${a.id_aluno}">${mt}</td>
            </tr>
         `;
      });

         tabela += `</tbody></table>`;
         boletimContainer.innerHTML = tabela;
         boletimContainer.style.display = 'block';
         salvarTodosBtn.style.display = 'block';
      }

      function atualizarCalculos(idAluno) {
         const i1 = parseFloat(document.getElementById(`i1-${idAluno}`).value);
         const i2 = parseFloat(document.getElementById(`i2-${idAluno}`).value);
         const epa = parseFloat(document.getElementById(`epa-${idAluno}`).value);
         const n2 = parseFloat(document.getElementById(`n2-${idAluno}`).value);
         const n3 = parseFloat(document.getElementById(`n3-${idAluno}`).value);
         const rec = parseFloat(document.getElementById(`rec-${idAluno}`).value);
         
         const n1 = calcularN1(i1, i2, epa);
         document.getElementById(`n1-display-${idAluno}`).textContent = n1;

         const mp = calcularMP(n1, n2, n3);
         document.getElementById(`mp-display-${idAluno}`).textContent = mp;

         const mt = calcularMT(mp, rec);
         document.getElementById(`mt-display-${idAluno}`).textContent = mt;
         
         const todosPreenchidos = [i1, i2, epa, n2, n3].every(v => !isNaN(v) && v !== '');
         const recInput = document.getElementById(`rec-${idAluno}`);
         const mpNum = parseFloat(mp);
         
         if (todosPreenchidos && !isNaN(mpNum) && mpNum < 6) {
            recInput.disabled = false;
         } else {
            recInput.disabled = true;
            if (mpNum >= 6) {
               recInput.value = '';
            }
         }
      }

      async function salvarTodasNotas() {
         const id_trimestre = document.getElementById('trimestre-select').value;
         
         if (!disciplinaAtual || alunosCarregados.length === 0) {
            alert('Nenhum aluno carregado!');
            return;
         }

         salvarTodosBtn.disabled = true;
         salvarTodosBtn.textContent = '⏳ Salvando...';

         let sucessos = 0;
         let erros = 0;

         for (const aluno of alunosCarregados) {
            const payload = {
               id_aluno: aluno.id_aluno,
               id_disciplina: disciplinaAtual,
               i1: document.getElementById(`i1-${aluno.id_aluno}`).value,
               i2: document.getElementById(`i2-${aluno.id_aluno}`).value,
               epa: document.getElementById(`epa-${aluno.id_aluno}`).value,
               n2: document.getElementById(`n2-${aluno.id_aluno}`).value,
               n3: document.getElementById(`n3-${aluno.id_aluno}`).value,
               rec: document.getElementById(`rec-${aluno.id_aluno}`).value,
               faltas: document.getElementById(`faltas-${aluno.id_aluno}`).value,
               trimestre: id_trimestre
            };

            try {
               const res = await fetch('/api/notas', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
               });

               if (res.ok) {
                  sucessos++;
               } else {
                  erros++;
               }
            } catch (err) {
               erros++;
               console.error('Erro ao salvar nota do aluno:', aluno.nome, err);
            }
         }

         salvarTodosBtn.disabled = false;
         salvarTodosBtn.textContent = ' Salvar Notas de Todos os Alunos';

         if (erros === 0) {
            alert(`✅ Todas as ${sucessos} notas foram salvas com sucesso!`);
         } else {
            alert(`⚠️ ${sucessos} notas salvas com sucesso.\n${erros} notas falharam.`);
         }
      }

      function validarNota(input) {
         if (input.value.trim() === '') {
           return;
         }

         let valor = parseFloat(input.value);

         if (isNaN(valor)) {
            input.value = '';
            return;
         }

         if (valor < 0) {
            valor = 0;
         } 
         else if (valor > 10 && valor <= 100) {
            valor = valor / 10;
         } 
         else if (valor > 10) {
            valor = 10;
         }

         valor = Math.round(valor * 100) / 100;
         input.value = valor;
      }

      document.getElementById('carregarBtn').addEventListener('click', carregarAlunos);
      salvarTodosBtn.addEventListener('click', salvarTodasNotas);

      carregarTurmas();
   </script>
</body>
</html>